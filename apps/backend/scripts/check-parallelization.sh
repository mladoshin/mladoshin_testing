#!/bin/bash

echo "=== –ê–Ω–∞–ª–∏–∑ –ø–∞—Ä–∞–ª–ª–µ–ª–∏–∑–∞—Ü–∏–∏ Jest –≤ –ø—Ä–æ–µ–∫—Ç–µ ==="
echo ""

# –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ CPU —è–¥–µ—Ä
CPU_CORES=$(sysctl -n hw.ncpu 2>/dev/null || nproc 2>/dev/null || echo "N/A")
echo "üñ•Ô∏è  CPU —è–¥–µ—Ä –Ω–∞ –º–∞—à–∏–Ω–µ: $CPU_CORES"

# –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–µ—Å—Ç–æ–≤—ã—Ö —Ñ–∞–π–ª–æ–≤
TEST_FILES=$(find src -name "*.spec.ts" | wc -l | tr -d ' ')
echo "üìÅ –í—Å–µ–≥–æ —Ç–µ—Å—Ç–æ–≤—ã—Ö —Ñ–∞–π–ª–æ–≤: $TEST_FILES"
echo ""

# –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –∏–∑ package.json
echo "‚öôÔ∏è  –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –≤ package.json:"
echo "   - test:parallel: --maxWorkers=4"
echo "   - test:sequential: --runInBand (1 –ø—Ä–æ—Ü–µ—Å—Å)"
echo ""

# –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
echo "üí° –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:"
if [ "$CPU_CORES" != "N/A" ]; then
  AUTO_WORKERS=$((CPU_CORES - 1))
  echo "   - –ê–≤—Ç–æ —Ä–µ–∂–∏–º (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é): $AUTO_WORKERS –≤–æ—Ä–∫–µ—Ä–æ–≤"
  echo "   - 50% CPU: $((CPU_CORES / 2)) –≤–æ—Ä–∫–µ—Ä–æ–≤"
fi
echo "   - Development: 2-4 –≤–æ—Ä–∫–µ—Ä–∞"
echo "   - CI/CD: 50% –∏–ª–∏ –∞–≤—Ç–æ"
echo "   - Debugging: --runInBand"
echo ""

echo "üîç –ö–∞–∫ Jest —Ä–∞—Å–ø—Ä–µ–¥–µ–ª—è–µ—Ç —Ä–∞–±–æ—Ç—É:"
echo "   ‚úì –ö–∞–∂–¥—ã–π .spec.ts —Ñ–∞–π–ª = –æ—Ç–¥–µ–ª—å–Ω–∞—è –µ–¥–∏–Ω–∏—Ü–∞ —Ä–∞–±–æ—Ç—ã"
echo "   ‚úì –í—Å–µ —Ç–µ—Å—Ç—ã –≤–Ω—É—Ç—Ä–∏ —Ñ–∞–π–ª–∞ –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ"
echo "   ‚úì –†–∞–∑–Ω—ã–µ —Ñ–∞–π–ª—ã –º–æ–≥—É—Ç –≤—ã–ø–æ–ª–Ω—è—Ç—å—Å—è –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ"
echo ""

echo "üìä –ü—Ä–∏–º–µ—Ä–Ω–∞—è –æ—Ü–µ–Ω–∫–∞ –≤—Ä–µ–º–µ–Ω–∏:"
echo "   - –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ (4 –≤–æ—Ä–∫–µ—Ä–∞): ~$(echo "scale=0; $TEST_FILES / 4" | bc) –ø–∞—á–µ–∫ —Ñ–∞–π–ª–æ–≤"
echo "   - –ü–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ: –≤—Å–µ $TEST_FILES —Ñ–∞–π–ª–æ–≤ –ø–æ –æ—á–µ—Ä–µ–¥–∏"
echo ""

echo "üöÄ –î–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –≤–æ—Ä–∫–µ—Ä–æ–≤:"
echo "   jest --maxWorkers=8       # –ö–æ–Ω–∫—Ä–µ—Ç–Ω–æ–µ —á–∏—Å–ª–æ"
echo "   jest --maxWorkers=50%     # –ü—Ä–æ—Ü–µ–Ω—Ç –æ—Ç CPU"
echo "   jest --runInBand          # –û–¥–∏–Ω –ø—Ä–æ—Ü–µ—Å—Å"
