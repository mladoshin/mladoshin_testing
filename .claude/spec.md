# Спецификация проекта: Школа онлайн курсов

## 1. Общая информация

**Название проекта:** Школа онлайн курсов
**Тип проекта:** Учебный проект для дисциплины "Тестирование и отладка" (МГТУ им. Н.Э. Баумана)
**Автор:** Ладошин Максим
**Версия:** 0.0.1
**Тип приложения:** Web SPA (Single Page Application)

## 2. Описание проекта

### 2.1 Краткое описание
Приложение позволяет студентам просматривать доступные курсы и покупать доступ к понравившимся курсам. Администратор имеет возможность создавать курсы, просматривать участников курсов, просматривать оплаты участников, создавать выписки по зачислениям.

### 2.2 Цель проекта
Создать скелетон (MVP) для создания онлайн школ различной сложности. Онлайн обучение очень востребовано сегодня, поэтому на рынке существует очень много подобных решений.

### 2.3 Предметная область
- **Пользователи** — все пользователи платформы с несколькими ролями (администратор и студент)
- **Курсы** — все курсы, созданные администраторами
- **Уроки** — содержимое курсов с текстовым контентом
- **Платежные транзакции** — все платежи, которые совершили пользователи

## 3. Архитектура приложения

### 3.1 Технологический стек

**Backend (NestJS):**
- Runtime: Node.js
- Язык: TypeScript
- Фреймворк: NestJS 11.x
- База данных (production): PostgreSQL
- База данных (tests): SQLite (изолированные схемы для каждого тест-файла)
- Кеш: Redis
- ORM: TypeORM 0.3.x
- Аутентификация: JWT (jsonwebtoken)
- Хеширование паролей: bcryptjs
- Валидация: class-validator, class-transformer

**Frontend (React):**
- Язык: TypeScript
- Фреймворк: React 19.x
- Роутинг: React Router DOM 7.x
- Стейт-менеджмент: Zustand
- Стилизация: Tailwind CSS 4.x, SCSS, PostCSS
- HTTP клиент: Axios
- Иконки: Heroicons
- Сборщик: Vite 6.x

**Тестирование (Backend):**
- Фреймворк: Jest 29.x
- Test runner: ts-jest
- Отчеты: Allure Jest 3.x
- Типы тестов: Unit, Integration
- Параллелизация: До 4 воркеров

**Общее:**
- Монорепозиторий: pnpm workspaces
- Shared types: TypeScript типы между frontend и backend
- Линтинг: ESLint 9.x
- Форматирование: Prettier 3.x

### 3.2 Структура проекта

```
/
├── .claude/                    # Конфигурация Claude Code
│   ├── spec.md                # Данная спецификация
│   └── lab_03/                # Лабораторная работа №3
│       ├── spec.md            # Специфика ЛР3
│       └── plan.md            # План ЛР3
├── apps/
│   ├── backend/               # NestJS приложение
│   │   ├── src/
│   │   │   ├── common/       # Общие утилиты, guards, decorators
│   │   │   ├── modules/      # Модули приложения
│   │   │   └── main.ts       # Точка входа
│   │   ├── tests/            # E2E тесты
│   │   ├── docs/             # Документация
│   │   ├── scripts/          # Bash скрипты
│   │   ├── allure-results/   # Результаты тестов Allure
│   │   └── allure-report/    # HTML отчеты Allure
│   ├── gui/                   # React приложение
│   └── logs/                  # Логи приложений
├── packages/
│   └── shared-types/          # Общие TypeScript типы
├── diagrams/                  # Диаграммы проектирования
├── img/                       # Изображения для документации
├── README.md                  # Основная документация
└── pnpm-workspace.yaml        # Конфигурация монорепозитория
```

### 3.3 Архитектура Backend (NestJS)

#### Структура модулей
Каждый модуль следует единому паттерну:
- **Controller** — HTTP endpoints и обработка запросов/ответов
- **Service** — Бизнес-логика
- **Repository** — Слой доступа к данным с интерфейсом (IXxxRepo)
- **Entity** — TypeORM сущности базы данных
- **Domain** — Доменные модели (отделены от БД сущностей)
- **Mapper** — Конвертация между entity и domain объектами
- **DTOs** — Data Transfer Objects в папке `dto/`
- **Tests** — Тесты в папке `tests/` внутри каждого модуля

#### Ключевые модули
- `auth/` — JWT аутентификация (login, register, управление токенами)
- `users/` — Управление пользователями и профилями
- `courses/` — CRUD операции с курсами
- `lessons/` — Управление уроками
- `payments/` — Обработка платежей
- `course-enrollments/` — Регистрация студентов на курсы
- `user-availability/` — Отслеживание доступности преподавателей
- `user-schedule/` — Система расписания

#### Общий код
- `src/common/services/` — TokenService (JWT), HashService (bcrypt)
- `src/common/errors/` — Кастомные классы ошибок
- `src/common/logging/` — LogService, ErrorLoggerInterceptor
- `src/common/tests/builders/` — Test data builders для сущностей
- `src/common/tests/object-mothers/` — Фабрики тестовых данных

#### Паттерн Dependency Injection
Сервисы и репозитории инжектятся через интерфейсы:
```typescript
constructor(
  @Inject('IUserRepo') private readonly userRepository: IUserRepo,
  @Inject('IHashService') private readonly hashService: IHashService,
)
```

#### Слой базы данных
- TypeORM с PostgreSQL (production) и SQLite (tests)
- Каждый интеграционный тест создает изолированную схему БД
- Кастомные ошибки репозиториев: RepositoryNotFoundError, RepositoryUnknownError, RepositoryDuplicateError, RepositoryForbiddenError
- Репозитории реализуют паттерн findOrFailById() с выбросом исключений

#### Аутентификация
- JWT-based с access и refresh токенами
- Guards: AuthGuard (обязательная аутентификация), OptionalAuthGuard (опциональная)
- Token payload: `{ id, email, role }`
- Токены создаются через TokenService.create(body, secret, expiresIn)

#### Глобальные настройки
- Переменные окружения через @nestjs/config (global)
- Глобальный API prefix: `/api`
- Глобальный validation pipe с whitelist и forbidNonWhitelisted
- Глобальный error logging interceptor
- CORS включен для `http://localhost:5173`

## 4. Роли пользователей

### 4.1 Неавторизованный пользователь
- Просмотр списка публичных курсов
- Регистрация в системе
- Авторизация

### 4.2 Студент (авторизованный пользователь)
- Все права неавторизованного пользователя
- Просмотр профиля
- Регистрация на курсы
- Оплата доступа к платным курсам
- Просмотр содержимого курсов
- Доступ к урокам купленных курсов

### 4.3 Администратор
- Все права студента (кроме оплаты)
- Создание курсов
- Редактирование курсов
- Добавление уроков в курсы
- Просмотр участников курсов
- Просмотр платежных транзакций
- Создание выписок по зачислениям

## 5. Основные функциональные требования

### 5.1 Аутентификация и авторизация
- FR-1.1: Регистрация пользователя с email и паролем
- FR-1.2: Авторизация с генерацией JWT токенов
- FR-1.3: Refresh токены для продления сессии
- FR-1.4: Ролевая модель доступа (студент/администратор)

### 5.2 Управление курсами
- FR-2.1: Просмотр списка курсов
- FR-2.2: Просмотр деталей курса
- FR-2.3: Создание курса (администратор)
- FR-2.4: Редактирование курса (администратор)
- FR-2.5: Добавление уроков в курс (администратор)
- FR-2.6: Просмотр содержимого курса
- FR-2.7: Категоризация курсов (бесплатные/платные)

### 5.3 Управление уроками
- FR-3.1: Создание урока с текстовым контентом
- FR-3.2: Редактирование урока
- FR-3.3: Просмотр урока студентом

### 5.4 Система платежей
- FR-4.1: Оплата доступа к платному курсу
- FR-4.2: Создание платежной транзакции
- FR-4.3: Просмотр истории платежей (администратор)
- FR-4.4: Формирование выписок по зачислениям (администратор)

### 5.5 Регистрация на курсы
- FR-5.1: Регистрация на бесплатный курс
- FR-5.2: Регистрация на платный курс после оплаты
- FR-5.3: Проверка доступа студента к курсу
- FR-5.4: Просмотр списка участников курса (администратор)

## 6. Стратегия тестирования

### 6.1 Типы тестов
- **Unit тесты:** Моки всех зависимостей (repository, services)
- **Integration тесты:** Реальная PostgreSQL база с изолированными схемами
- **Всего тестовых файлов:** 35

### 6.2 Механизм параллелизации
- Jest параллелизирует **только на уровне файлов** (не внутри файлов)
- По умолчанию: 4 воркера в параллельном режиме
- Все тесты в одном `.spec.ts` выполняются последовательно в одном процессе
- Доступна рандомизация через `jest.config.random.ts`

### 6.3 Offline режим
- Установка `IS_OFFLINE=true` пропускает интеграционные тесты
- Полезно для CI/CD или при отсутствии БД

### 6.4 Паттерны тестовых данных
- **Builders:** Гибкое построение объектов (`new UserBuilder().withEmail('x').build()`)
- **Object Mothers:** Предопределенные сценарии (`UserObjectMother.createStudent()`)
- Находятся в `src/common/tests/builders/` и `src/common/tests/object-mothers/`

### 6.5 Команды тестирования

```bash
# Базовые команды
npm run test:parallel          # 4 воркера (быстрее)
npm run test:sequential        # 1 процесс (стабильнее)
npm run test:parallel:random   # Параллельно с рандомизацией
npm run test:sequential:random # Последовательно с рандомизацией

# Расширенный runner
./run-tests.sh [OPTIONS]
  -o                           # Offline режим
  -m MODE                      # parallel или sequential
  -r                           # Рандомизация
  -s                           # Показать Allure отчет
  -t PATH                      # Запустить конкретный тест

# Конкретные тесты
npm run test:parallel -- auth.service.spec.ts
npm run test:parallel -- src/modules/auth
npm run test:parallel -- --testNamePattern="login"

# Утилиты
npm run test:watch             # Watch режим
npm run test:cov               # С покрытием
npm run test:debug             # Debug режим
```

### 6.6 Allure отчеты

```bash
npm run allure:show            # Открыть существующий отчет
npm run allure:append          # Сгенерировать отчет из результатов
npm run allure:prepare         # Подготовить историю перед тестами
npm run allure:clean           # Очистить все результаты
```

Структура:
- `allure-results/` — JSON файлы с результатами
- `allure-report/` — HTML отчет
- `allure-report/history/` — История прошлых запусков

## 7. Важные паттерны проектирования

### 7.1 Паттерн Repository Interface
Все репозитории доступны через интерфейсы:
1. Определить интерфейс с методами
2. Реализовать с TypeORM repository
3. Зарегистрировать с `{ provide: 'IUserRepo', useClass: UserRepo }`
4. Инжектить через `@Inject('IUserRepo')`

### 7.2 Разделение Domain-Entity
- **Entities** (`*.entity.ts`): TypeORM декораторы, маппинг БД
- **Domains** (`*.domain.ts`): Чистые TypeScript классы, бизнес-логика
- **Mappers** (`*.mapper.ts`): Конвертация entity ↔ domain с методом `toDomainEntity()`

### 7.3 Обработка ошибок
- Репозитории выбрасывают кастомные подклассы RepositoryError
- Сервисы ловят и перебрасывают как NestJS исключения
- Глобальный ErrorLoggerInterceptor логирует все ошибки
- Использовать ConfigService.getOrThrow() для обязательных env переменных

## 8. Конфигурация окружения

### 8.1 Переменные окружения (.env)

**Обязательные переменные:**
- `POSTGRES_HOST`, `POSTGRES_PORT`, `POSTGRES_USER`, `POSTGRES_PASSWORD`, `POSTGRES_DB`
- `JWT_SECRET`, `JWT_EXPIRES_IN`
- `JWT_REFRESH_SECRET`, `JWT_REFRESH_EXPIRES_IN`
- `PORT` (по умолчанию: 3000)

**Тестовое окружение:** `.env.test` с отдельной БД

### 8.2 Path Aliases

Настроено в `tsconfig.json`:
- `src/*` → `./src/*`
- `@modules/*` → `./src/modules/*`

Jest зеркалирует в `moduleNameMapper`

## 9. Команды разработки

### 9.1 Backend

```bash
# Разработка
npm run start:dev              # С hot-reload
npm run start:debug            # С отладчиком
npm run build                  # Production сборка
npm run start:prod             # Запуск production

# База данных
npm run console                # CLI для операций с БД
npm run pg:update-function     # Обновить PostgreSQL функции (dev)
npm run pg:update-test-function # Обновить PostgreSQL функции (test)

# Качество кода
npm run lint                   # ESLint с auto-fix
npm run format                 # Prettier форматирование
```

### 9.2 Frontend

```bash
npm run dev                    # Запуск dev сервера
npm run build                  # Production сборка
npm run preview                # Превью production сборки
npm run lint                   # ESLint
```

## 10. Диаграммы и документация

### 10.1 Доступные диаграммы
- Use-Case UML диаграмма: `img/analysis/use_cases_uml.png`
- ER-диаграмма: `img/analysis/erd.png`
- Верхнеуровневые компоненты: `img/analysis/high_level.png`
- UML диаграмма классов: `img/analysis/bl_da_erd.png`
- Диаграмма БД: `img/analysis/db_erd.png`
- BPMN-диаграмма: `img/analysis/bpmn.png`
- Обновленная UML диаграмма: `img/analysis/uml_new.png`

### 10.2 Документация Backend
- README: `apps/backend/docs/README.md`
- Параллелизация: `apps/backend/docs/PARALLELIZATION.md`
- CI/CD: `apps/backend/docs/CI-CD.md`
- Allure отчеты: `apps/backend/docs/ALLURE-REPORTS.md`
- Docker: `apps/backend/docs/DOCKER.md`
- Руководство Claude: `apps/backend/docs/CLAUDE.md`
- Исправления: `apps/backend/docs/FIXES.md`
- Quickstart: `apps/backend/docs/QUICKSTART.md`

## 11. Контекст монорепозитория

Backend — часть монорепозитория (см. зависимость `"@shared/types": "workspace:*"`). Общие типы импортируются из workspace package.

## 12. Анализ аналогичных решений

| Платформа | Роль куратора | Количество пользователей | Количество курсов |
|-----------|---------------|-------------------------|-------------------|
| Яндекс Практикум | Да | 1 000 000+ | 100+ |
| Онлайн-школа Nisarga | Да | до 1000 | до 100 |
| Онлайн-школа Нетология | Нет | 1 000 000+ | 500+ |

**Критерии сравнения:**
- Наличие роли куратора
- Масштаб (количество пользователей)
- Разнообразие контента (количество курсов)

## 13. Типовые пользовательские сценарии

### Сценарий 1: Просмотр профиля
1. Авторизоваться
2. Нажать кнопку "Профиль" для просмотра профиля

### Сценарий 2: Регистрация на курс
1. Авторизоваться
2. Выбрать курс
3. Нажать кнопку "Зарегистрироваться" (если курс еще не начался)
4. Если курс бесплатный → зарегистрировать пользователя на курс
5. Если курс платный → показать окно оплаты с суммой и кнопкой
6. При нажатии кнопки оплаты → создать транзакцию → показать сообщение об успехе → зарегистрировать на курс

### Сценарий 3: Добавление курса (администратор)
1. Авторизоваться как администратор
2. Зайти в окно добавления курсов
3. Заполнить данные курса (название, описание, цена, и т.д.)
4. Нажать кнопку "Добавить"

### Сценарий 4: Добавление урока в курс (администратор)
1. Авторизоваться как администратор
2. Зайти на страницу курса
3. Перейти на страницу добавления урока
4. Заполнить данные урока (название, текстовое содержимое)
5. Нажать кнопку "Сохранить"

## 14. Troubleshooting

### Тесты падают с ошибками подключения к БД
- Проверьте настройки в `.env.test`
- Убедитесь, что PostgreSQL запущен
- Проверьте права доступа пользователя БД

### Offline режим
- Используйте флаг `-o` для пропуска интеграционных тестов
- Полезно при отсутствии доступа к БД или в CI/CD

### Allure не открывается
- Убедитесь, что Allure установлен: `npm install -g allure-commandline`
- Проверьте наличие результатов в `allure-results/`

## 15. Лицензия и статус

- **Лицензия:** UNLICENSED (учебный проект)
- **Статус:** В разработке (MVP)
- **Private:** true

---

**Последнее обновление:** 2025-11-12
**Актуальность спецификации:** Соответствует текущей версии проекта
